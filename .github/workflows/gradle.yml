name: Java CI with Gradle (improved)

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug - show repo layout
        run: |
          echo "WORKSPACE: $GITHUB_WORKSPACE"
          pwd
          echo "Root listing:"
          ls -la
          echo "Find Gradle-related files (maxdepth 4):"
          find . -maxdepth 4 -type f \( -name "settings.gradle" -o -name "settings.gradle.kts" -o -name "build.gradle" -o -name "build.gradle.kts" -o -name "gradlew" \) -print || true

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # (Opcional) Provisiona o Gradle no runner. Se sempre usar wrapper, não é necessário.
      - name: Setup Gradle (installs Gradle on the runner)   # opcional
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '8.4'

      - name: Build (use gradle wrapper if present)
        run: |
          # detecta diretório do projeto (onde existe settings.gradle ou build.gradle)
          DIR=$(find . -maxdepth 3 -type f \( -name "settings.gradle" -o -name "settings.gradle.kts" -o -name "build.gradle" -o -name "build.gradle.kts" \) -printf '%h\n' | sort -u | head -n1)
          if [ -z "$DIR" ]; then
            echo "ERROR: no Gradle build files found in workspace"; exit 1
          fi
          echo "Found Gradle project in: $DIR"
          cd "$DIR"
          if [ -f "./gradlew" ]; then
            echo "Using project gradle wrapper"
            chmod +x ./gradlew
            ./gradlew --no-daemon clean build
          else
            echo "./gradlew not found, falling back to system gradle"
            gradle --no-daemon clean build
          fi
